<div class="max-w-6xl mx-auto mb-6">
  <div class="brutal-border bg-white p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="text-sm text-gray-600">$ grep -r ".*" ~/notes</p>
        <h1 class="text-3xl md:text-4xl font-bold mt-2">Search æœç´¢</h1>
      </div>
      <a
        href="/"
        class="brutal-btn brutal-border bg-white px-4 py-2 text-sm hover:bg-yellow-300"
      >
        â† BACK
      </a>
    </div>

    <div class="relative">
      <input
        type="text"
        id="searchInput"
        placeholder="$ search --query='react hooks' ..."
        class="brutal-border w-full px-4 py-3 text-lg focus:outline-none focus:ring-0"
      />
      <button
        class="absolute right-2 top-2 brutal-btn brutal-border bg-white px-4 py-2 text-sm hover:bg-cyan-300"
      >
        [SEARCH]
      </button>
    </div>
  </div>

  <div class="grid md:grid-cols-3 gap-4 mb-6">
    <div class="md:col-span-2 brutal-border bg-white p-4">
      <p class="text-sm font-bold mb-3">$ filter --by=category</p>
      <div class="flex flex-wrap gap-2" id="categoryFilters">
        <div
          class="filter-chip brutal-border bg-black text-white px-3 py-2 text-sm font-bold cursor-pointer"
          data-category="all"
        >
          [ALL]
        </div>
      </div>
    </div>

    <div class="brutal-border bg-black text-white p-4">
      <p class="text-sm font-bold mb-3">$ wc -l notes/*</p>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span>Total notes:</span>
          <span id="totalNotes" class="font-bold">Loading...</span>
        </div>
        <div class="flex justify-between">
          <span>Results:</span>
          <span id="resultCount" class="font-bold text-green-400">0</span>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto">
    <div class="brutal-border bg-white p-4 mb-4">
      <p class="text-sm">
        <span class="text-green-600">[+]</span>
        Showing <span id="showingCount" class="font-bold">0</span> results
      </p>
    </div>

    <div class="space-y-4" id="resultsContainer"></div>

    <div id="noResults" class="brutal-border bg-white p-12 text-center hidden">
      <p class="text-2xl font-bold mb-2">$ 404: RESULTS_NOT_FOUND</p>
      <p class="text-gray-600 mb-4">æ¢ä¸ªè¯è¯•è¯•ï¼Ÿ</p>
      <p class="mt-4"><span class="blink">_</span></p>
    </div>
  </div>
</div>

<script>
    const themeColors = <%- JSON.stringify(theme.category_colors || {}) %>;
  let postsData = [];
  const searchInput = document.getElementById("searchInput");
  const resultsContainer = document.getElementById("resultsContainer");
  const categoryContainer = document.getElementById("categoryFilters");
  const resultCount = document.getElementById("resultCount");
  const showingCount = document.getElementById("showingCount");
  const noResults = document.getElementById("noResults");
  let activeCategory = "all";

  // 1. è·å–æ•°æ®
  fetch("/content.json")
    .then((response) => {
      if (!response.ok) throw new Error("HTTP error " + response.status);
      return response.json();
    })
    .then((data) => {
      console.log("ğŸ“¦ Loaded Data:", data); // è°ƒè¯•ï¼šåœ¨æ§åˆ¶å°æ‰“å°æ•°æ®ç»“æ„
      postsData = data;
      initStats(data);
      initCategories(data);
      // é»˜è®¤ä¸æ˜¾ç¤ºï¼Œæˆ–è€…æ˜¾ç¤ºå…¨éƒ¨ï¼Œè¿™é‡Œè®¾ä¸ºæ˜¾ç¤ºå…¨éƒ¨
      renderResults(data);
    })
    .catch((err) => {
      console.error("âŒ Fetch Error:", err);
      resultsContainer.innerHTML = `<p class="text-red-500 font-bold">Error loading search data: ${err.message}</p>`;
    });

  // 2. æœç´¢ç›‘å¬
  searchInput.addEventListener("input", (e) => {
    const query = e.target.value.toLowerCase();
    filterData(query, activeCategory);
  });

  // 3. è¿‡æ»¤é€»è¾‘
  function filterData(query, category) {
    if (!postsData) return;

    const filtered = postsData.filter((post) => {
      // å…¼å®¹æ€§å¤„ç†ï¼šæœ‰äº›ä¸»é¢˜ç”Ÿæˆçš„ category æ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼Œæœ‰äº›æ˜¯å¯¹è±¡æ•°ç»„
      let postCats = [];
      if (post.categories) {
        if (typeof post.categories[0] === "string") {
          postCats = post.categories;
        } else if (typeof post.categories[0] === "object") {
          postCats = post.categories.map((c) => c.name);
        }
      }

      const inCategory = category === "all" || postCats.includes(category);

      // å…¼å®¹ content æˆ– text å­—æ®µ
      const contentText = post.content || post.text || "";
      const matchQuery =
        !query ||
        (post.title && post.title.toLowerCase().includes(query)) ||
        contentText.toLowerCase().includes(query);
      return inCategory && matchQuery;
    });
    renderResults(filtered);
  }

  // 4. æ¸²æŸ“æ ¸å¿ƒ
  function renderResults(posts) {
    try {
      // æ›´æ–°è®¡æ•°å™¨
      if (resultCount) resultCount.innerText = posts.length;
      if (showingCount) showingCount.innerText = posts.length;

      if (posts.length === 0) {
        resultsContainer.innerHTML = "";
        if (noResults) noResults.classList.remove("hidden");
        return;
      }

      if (noResults) noResults.classList.add("hidden");

      const html = posts
        .map((post) => {
          // æ—¥æœŸå®‰å…¨å¤„ç†
          const dateStr = post.date
            ? new Date(post.date).toLocaleDateString()
            : "N/A";

          // åˆ†ç±»å®‰å…¨å¤„ç†
          let catName = "UNCATEGORIZED";
          if (post.categories && post.categories.length > 0) {
            // åˆ¤æ–­æ˜¯å¯¹è±¡è¿˜æ˜¯å­—ç¬¦ä¸²
            catName =
              typeof post.categories[0] === "string"
                ? post.categories[0]
                : post.categories[0].name;
          }
          let displayCatName = 'UNCATEGORIZED';

          if (post.categories && post.categories.length > 0) {
              const c = post.categories[0];
              // æ‹¿åˆ°åˆ†ç±»åï¼Œæ¯”å¦‚ "Code"
              const rawName = typeof c === 'string' ? c : c.name;
              catName = rawName;
              displayCatName = rawName.toUpperCase();
          }
          const colorKey = themeColors[catName] || 'gray';
          const catColorClass = `bg-${colorKey}-300`;

          // æ‘˜è¦å¤„ç†ï¼šå»é™¤ HTML æ ‡ç­¾ï¼Œåªç•™çº¯æ–‡æœ¬
          const rawContent = post.content || post.text || "";
          // ç®€å•çš„æ­£åˆ™å»æ ‡ç­¾
          const plainText = rawContent.replace(/<[^>]+>/g, "");
          const snippet = plainText.substring(0, 150) + "...";

          // url è¿˜æ˜¯ path? æ’ä»¶é€šå¸¸ç»™ url æˆ– path
          const postLink = post.url || post.path || "#";

          return `
                <div class="search-result brutal-border bg-white p-6 relative group hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-1 transition-all">
                    <div class="flex flex-wrap items-start justify-between gap-4 mb-3 relative z-20">
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs brutal-border ${catColorClass} px-2 py-1 font-bold">[${catName.toUpperCase()}]</span>
                        </div>
                        <span class="text-xs text-gray-500">${dateStr}</span>
                    </div>

                    <h3 class="text-xl font-bold mb-2">
                        <a href="${postLink}" class="before:absolute before:inset-0 focus:outline-none">
                            ${post.title}
                        </a>
                    </h3>

                    <p class="text-sm text-gray-600 mb-3 line-clamp-2">
                        ${snippet}
                    </p>

                    <div class="flex gap-4 text-xs text-gray-500 relative z-20">
                         <span>ğŸ”— Open Post</span>
                    </div>
                </div>
                `;
        })
        .join("");

      resultsContainer.innerHTML = html;
    } catch (error) {
      console.error("âŒ Render Error:", error);
      // å³ä½¿æ¸²æŸ“å¤±è´¥ï¼Œä¹Ÿè®©ç”¨æˆ·çŸ¥é“
      resultsContainer.innerHTML = `<p class="text-red-500">Render Failed: ${error.message}. Check console (F12).</p>`;
    }
  }

  // 5. åˆå§‹åŒ–åˆ†ç±»æŒ‰é’®
  function initCategories(data) {
    if (!categoryContainer) return;
    const cats = new Set();
    data.forEach((p) => {
      if (p.categories) {
        p.categories.forEach((c) => {
          // å…¼å®¹å¯¹è±¡æˆ–å­—ç¬¦ä¸²
          const name = typeof c === "string" ? c : c.name;
          cats.add(name);
        });
      }
    });

    categoryContainer.innerHTML = "";
    // é‡å»º [ALL] æŒ‰é’®
    const allBtn = document.createElement("div");
    allBtn.className =
      "filter-chip brutal-border bg-black text-white px-3 py-2 text-sm font-bold cursor-pointer hover:bg-gray-800";
    allBtn.innerText = "[ALL]";
    allBtn.onclick = () => {
      activeCategory = "all";
      updateFilterStyles(allBtn);
      filterData(searchInput.value.toLowerCase(), "all");
    };
    categoryContainer.appendChild(allBtn);

    // ç”Ÿæˆå…¶ä»–åˆ†ç±»æŒ‰é’®
    Array.from(cats).forEach((cat, index) => {
      const btn = document.createElement("div");
      btn.className = `filter-chip brutal-border bg-white px-3 py-2 text-sm font-bold cursor-pointer hover:bg-gray-100`;
      btn.innerText = `[${cat.toUpperCase()}]`;
      btn.onclick = () => {
        activeCategory = cat;
        updateFilterStyles(btn);
        filterData(searchInput.value.toLowerCase(), cat);
      };
      categoryContainer.appendChild(btn);
    });
  }

  function updateFilterStyles(activeBtn) {
    document.querySelectorAll(".filter-chip").forEach((el) => {
      el.className = `filter-chip brutal-border bg-white px-3 py-2 text-sm font-bold cursor-pointer hover:bg-gray-100`;
    });
    activeBtn.className = `filter-chip brutal-border bg-black text-white px-3 py-2 text-sm font-bold cursor-pointer hover:bg-gray-800`;
  }

  function initStats(data) {
    if (document.getElementById("totalNotes")) {
      document.getElementById("totalNotes").innerText = data.length;
    }
  }
</script>
